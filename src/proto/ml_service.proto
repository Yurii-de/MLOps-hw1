syntax = "proto3";

package ml_service;

// Сервис для работы с ML моделями
service MLService {
  // Аутентификация
  rpc Login(LoginRequest) returns (LoginResponse);
  
  // Получить список доступных типов моделей
  rpc ListAvailableModels(Empty) returns (AvailableModelsResponse);
  
  // Обучить модель
  rpc TrainModel(TrainRequest) returns (TrainResponse);
  
  // Получить предсказание
  rpc Predict(PredictRequest) returns (PredictResponse);
  
  // Переобучить модель
  rpc RetrainModel(RetrainRequest) returns (TrainResponse);
  
  // Удалить модель
  rpc DeleteModel(DeleteRequest) returns (DeleteResponse);
  
  // Проверка статуса сервиса
  rpc HealthCheck(Empty) returns (HealthCheckResponse);
  
  // Получить список обученных моделей
  rpc ListTrainedModels(Empty) returns (TrainedModelsResponse);
  
  // Загрузить датасет
  rpc UploadDataset(UploadDatasetRequest) returns (UploadDatasetResponse);
  
  // Получить список датасетов
  rpc ListDatasets(Empty) returns (ListDatasetsResponse);
  
  // Получить информацию о датасете
  rpc GetDatasetInfo(DatasetRequest) returns (DatasetInfoResponse);
  
  // Обучить модель на датасете
  rpc TrainModelFromDataset(TrainFromDatasetRequest) returns (TrainResponse);
}

// Пустое сообщение
message Empty {}

// Запрос на аутентификацию
message LoginRequest {
  string username = 1;
  string password = 2;
}

// Ответ на аутентификацию
message LoginResponse {
  string access_token = 1;
  string token_type = 2;
}

// Информация о доступном типе модели
message AvailableModelInfo {
  string name = 1;
  string description = 2;
  map<string, string> default_hyperparameters = 3;
}

// Ответ со списком доступных моделей
message AvailableModelsResponse {
  repeated AvailableModelInfo models = 1;
}

// Данные для обучения
message TrainingData {
  repeated FloatArray features = 1;
  repeated int32 labels = 2;
}

// Массив float значений
message FloatArray {
  repeated float values = 1;
}

// Запрос на обучение модели
message TrainRequest {
  string model_type = 1;
  string model_name = 2;
  map<string, string> hyperparameters = 3;
  TrainingData train_data = 4;
}

// Ответ на обучение модели
message TrainResponse {
  string model_id = 1;
  string model_type = 2;
  string message = 3;
  map<string, double> metrics = 4;
}

// Запрос на предсказание
message PredictRequest {
  string model_id = 1;
  repeated FloatArray features = 2;
}

// Ответ с предсказаниями
message PredictResponse {
  string model_id = 1;
  repeated int32 predictions = 2;
  repeated FloatArray probabilities = 3;
}

// Запрос на переобучение
message RetrainRequest {
  string model_id = 1;
  string model_type = 2;
  map<string, string> hyperparameters = 3;
  TrainingData train_data = 4;
}

// Запрос на удаление
message DeleteRequest {
  string model_id = 1;
}

// Ответ на удаление
message DeleteResponse {
  string message = 1;
}

// Ответ health check
message HealthCheckResponse {
  string status = 1;
  string version = 2;
  int32 models_count = 3;
}

// Информация об обученной модели
message TrainedModelInfo {
  string model_id = 1;
  string model_type = 2;
  string created_at = 3;
  map<string, string> hyperparameters = 4;
  string owner = 5;  // Владелец модели или пусто если общая
  bool is_trained = 6;  // Статус обучения
  int32 n_features = 7;  // Количество признаков
}

// Ответ со списком обученных моделей
message TrainedModelsResponse {
  repeated TrainedModelInfo models = 1;
}

// Запрос на загрузку датасета
message UploadDatasetRequest {
  bytes file_content = 1;
  string target_column = 2;
  string dataset_name = 3;
  bool preprocess_categorical = 4;
  bool make_shared = 5;  // Сделать датасет общим (owner=None)
}

// Ответ на загрузку датасета
message UploadDatasetResponse {
  string dataset_id = 1;
  int32 rows = 2;
  int32 columns = 3;
  string target_column = 4;
  repeated string feature_columns = 5;
  string message = 6;
  string owner = 7;  // Владелец датасета или пусто если общий
}

// Запрос информации о датасете
message DatasetRequest {
  string dataset_id = 1;
}

// Информация о датасете
message DatasetInfoResponse {
  string dataset_id = 1;
  int32 rows = 2;
  int32 columns = 3;
  string target_column = 4;
  repeated string feature_columns = 5;
  string created_at = 6;
  string owner = 7;  // Владелец датасета или пусто если общий
}

// Список датасетов
message ListDatasetsResponse {
  repeated DatasetInfoResponse datasets = 1;
}

// Запрос на обучение модели на датасете
message TrainFromDatasetRequest {
  string model_type = 1;
  string model_name = 2;
  string dataset_id = 3;
  map<string, string> hyperparameters = 4;
}
